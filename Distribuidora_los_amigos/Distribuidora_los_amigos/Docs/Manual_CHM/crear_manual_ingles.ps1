# ============================================
# Script Automatizado: Crear Manual en Inglés
# Distribuidora Los Amigos
# ============================================

param(
    [string]$BaseDir = "C:\Mac\Home\Documents\ProyectoFinal_Diploma\Distribuidora_los_amigos\Manual"
)

Write-Host ""
Write-Host "??????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
Write-Host "?                                                                ?" -ForegroundColor Cyan
Write-Host "?       CREADOR AUTOMÁTICO DE MANUAL EN INGLÉS                  ?" -ForegroundColor Cyan
Write-Host "?       Distribuidora Los Amigos                                 ?" -ForegroundColor Cyan
Write-Host "?                                                                ?" -ForegroundColor Cyan
Write-Host "??????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
Write-Host ""

# Verificar que existe el directorio base
if (-not (Test-Path $BaseDir)) {
    Write-Host "? Error: No se encontró el directorio base:" -ForegroundColor Red
    Write-Host "   $BaseDir" -ForegroundColor White
    Write-Host ""
    Write-Host "Por favor, verifica la ruta y ejecuta nuevamente." -ForegroundColor Yellow
    exit 1
}

# Verificar que existe source_es
$sourceEsDir = Join-Path $BaseDir "source_es"
if (-not (Test-Path $sourceEsDir)) {
    Write-Host "? Error: No se encontró el directorio source_es:" -ForegroundColor Red
    Write-Host "   $sourceEsDir" -ForegroundColor White
    Write-Host ""
    Write-Host "Asegúrate de que el manual en español existe." -ForegroundColor Yellow
    exit 1
}

Write-Host "?? Directorio base: $BaseDir" -ForegroundColor White
Write-Host ""

# ============================================
# PASO 1: Copiar estructura de source_es a source_en
# ============================================
Write-Host "????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
Write-Host "  PASO 1: Copiando estructura de carpetas" -ForegroundColor Cyan
Write-Host "????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
Write-Host ""

$sourceEnDir = Join-Path $BaseDir "source_en"

if (Test-Path $sourceEnDir) {
    Write-Host "??  El directorio source_en ya existe." -ForegroundColor Yellow
    $respuesta = Read-Host "¿Deseas sobrescribirlo? (S/N)"
    
    if ($respuesta -ne "S" -and $respuesta -ne "s") {
        Write-Host "? Operación cancelada por el usuario." -ForegroundColor Red
        exit 0
    }
    
    Write-Host "???  Eliminando source_en anterior..." -ForegroundColor Yellow
    Remove-Item $sourceEnDir -Recurse -Force
}

Write-Host "?? Copiando source_es ? source_en..." -ForegroundColor Yellow
Copy-Item $sourceEsDir -Destination $sourceEnDir -Recurse -Force

if (Test-Path $sourceEnDir) {
    Write-Host "? Estructura copiada exitosamente" -ForegroundColor Green
} else {
    Write-Host "? Error al copiar la estructura" -ForegroundColor Red
    exit 1
}

Write-Host ""

# ============================================
# PASO 2: Renombrar archivos del proyecto
# ============================================
Write-Host "????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
Write-Host "  PASO 2: Renombrando archivos del proyecto" -ForegroundColor Cyan
Write-Host "????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
Write-Host ""

Set-Location $sourceEnDir

$archivosARenombrar = @(
    @{Viejo="help_es.hhp"; Nuevo="help_en.hhp"},
    @{Viejo="help_es.hhc"; Nuevo="help_en.hhc"},
    @{Viejo="help_es.hhk"; Nuevo="help_en.hhk"}
)

foreach ($archivo in $archivosARenombrar) {
    if (Test-Path $archivo.Viejo) {
        Write-Host "?? Renombrando: $($archivo.Viejo) ? $($archivo.Nuevo)" -ForegroundColor Yellow
        Rename-Item $archivo.Viejo $archivo.Nuevo -Force
        Write-Host "   ? Renombrado" -ForegroundColor Green
    } else {
        Write-Host "   ??  No se encontró: $($archivo.Viejo)" -ForegroundColor Yellow
    }
}

Write-Host ""

# ============================================
# PASO 3: Editar help_en.hhp
# ============================================
Write-Host "????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
Write-Host "  PASO 3: Editando help_en.hhp" -ForegroundColor Cyan
Write-Host "????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
Write-Host ""

$hhpFile = Join-Path $sourceEnDir "help_en.hhp"

if (Test-Path $hhpFile) {
    Write-Host "?? Leyendo help_en.hhp..." -ForegroundColor Yellow
    
    # Leer contenido con codificación UTF-8
    $hhpContent = Get-Content $hhpFile -Encoding UTF8
    
    Write-Host "?? Aplicando cambios..." -ForegroundColor Yellow
    
    # Reemplazar referencias a help_es por help_en
    $hhpContent = $hhpContent -replace "help_es\.chm", "help_en.chm"
    $hhpContent = $hhpContent -replace "help_es\.hhc", "help_en.hhc"
    $hhpContent = $hhpContent -replace "help_es\.hhk", "help_en.hhk"
    
    # Cambiar idioma
    $hhpContent = $hhpContent -replace "0x0c0a Espanol.*", "0x0409 English (United States)"
    
    # Cambiar título
    $hhpContent = $hhpContent -replace "Manual de Usuario - Distribuidora Los Amigos", "User Manual - Distribuidora Los Amigos"
    
    # Guardar con UTF-8
    $hhpContent | Out-File $hhpFile -Encoding UTF8 -Force
    
    Write-Host "? help_en.hhp editado correctamente" -ForegroundColor Green
    Write-Host ""
    Write-Host "   Cambios aplicados:" -ForegroundColor White
    Write-Host "   • Compiled file ? help_en.chm" -ForegroundColor Gray
    Write-Host "   • Contents file ? help_en.hhc" -ForegroundColor Gray
    Write-Host "   • Index file ? help_en.hhk" -ForegroundColor Gray
    Write-Host "   • Language ? 0x0409 (English)" -ForegroundColor Gray
    Write-Host "   • Title ? User Manual" -ForegroundColor Gray
} else {
    Write-Host "? Error: No se encontró help_en.hhp" -ForegroundColor Red
    exit 1
}

Write-Host ""

# ============================================
# PASO 4: Verificar estructura
# ============================================
Write-Host "????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
Write-Host "  PASO 4: Verificando estructura" -ForegroundColor Cyan
Write-Host "????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
Write-Host ""

# Verificar archivos del proyecto
Write-Host "?? Verificando archivos del proyecto:" -ForegroundColor Yellow
Write-Host ""

$archivosProyecto = @("help_en.hhp", "help_en.hhc", "help_en.hhk")
foreach ($archivo in $archivosProyecto) {
    $rutaArchivo = Join-Path $sourceEnDir $archivo
    if (Test-Path $rutaArchivo) {
        Write-Host "   ? $archivo" -ForegroundColor Green
    } else {
        Write-Host "   ? $archivo" -ForegroundColor Red
    }
}

Write-Host ""

# Contar archivos HTML
Write-Host "?? Verificando archivos HTML:" -ForegroundColor Yellow
$htmlDir = Join-Path $sourceEnDir "html"
$htmlFiles = Get-ChildItem $htmlDir -Recurse -Filter "*.html"
$htmlCount = $htmlFiles.Count

if ($htmlCount -eq 32) {
    Write-Host "   ? Archivos HTML: $htmlCount (correcto)" -ForegroundColor Green
} elseif ($htmlCount -gt 0) {
    Write-Host "   ??  Archivos HTML: $htmlCount (esperados: 32)" -ForegroundColor Yellow
} else {
    Write-Host "   ? No se encontraron archivos HTML" -ForegroundColor Red
}

Write-Host ""

# Verificar CSS
Write-Host "?? Verificando archivos CSS:" -ForegroundColor Yellow
$cssFile = Join-Path $sourceEnDir "css\styles.css"
if (Test-Path $cssFile) {
    Write-Host "   ? styles.css" -ForegroundColor Green
} else {
    Write-Host "   ? styles.css no encontrado" -ForegroundColor Red
}

Write-Host ""

# ============================================
# PASO 5: Compilar CHM
# ============================================
Write-Host "????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
Write-Host "  PASO 5: Compilando CHM en inglés" -ForegroundColor Cyan
Write-Host "????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
Write-Host ""

$hhcPath = "C:\Program Files (x86)\HTML Help Workshop\hhc.exe"

if (-not (Test-Path $hhcPath)) {
    Write-Host "? Error: No se encontró HTML Help Workshop en:" -ForegroundColor Red
    Write-Host "   $hhcPath" -ForegroundColor White
    Write-Host ""
    Write-Host "Por favor, instala HTML Help Workshop y ejecuta nuevamente." -ForegroundColor Yellow
    exit 1
}

Write-Host "?? Compilando help_en.chm..." -ForegroundColor Yellow
Write-Host ""

Set-Location $sourceEnDir

# Ejecutar compilador
& $hhcPath "help_en.hhp" 2>&1 | Out-Null

Write-Host ""

# ============================================
# PASO 6: Verificar resultado
# ============================================
Write-Host "????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
Write-Host "  PASO 6: Verificando resultado" -ForegroundColor Cyan
Write-Host "????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
Write-Host ""

Set-Location $BaseDir

$chmFile = Join-Path $BaseDir "help_en.chm"

if (Test-Path $chmFile) {
    $chm = Get-Item $chmFile
    
    Write-Host ""
    Write-Host "??????????????????????????????????????????????????????????????????" -ForegroundColor Green
    Write-Host "?                                                                ?" -ForegroundColor Green
    Write-Host "?                    ? ÉXITO TOTAL                              ?" -ForegroundColor Green
    Write-Host "?                                                                ?" -ForegroundColor Green
    Write-Host "??????????????????????????????????????????????????????????????????" -ForegroundColor Green
    Write-Host ""
    Write-Host "?? Archivo generado:" -ForegroundColor Cyan
    Write-Host "   $chmFile" -ForegroundColor White
    Write-Host ""
    Write-Host "?? Información del archivo:" -ForegroundColor Cyan
    Write-Host "   Nombre:           $($chm.Name)" -ForegroundColor White
    Write-Host "   Tamaño:           $($chm.Length) bytes" -ForegroundColor White
    Write-Host "   Fecha creación:   $($chm.LastWriteTime)" -ForegroundColor White
    Write-Host ""
    Write-Host "????????????????????????????????????????????????????????????????" -ForegroundColor Yellow
    Write-Host "  ??  SIGUIENTE PASO IMPORTANTE" -ForegroundColor Yellow
    Write-Host "????????????????????????????????????????????????????????????????" -ForegroundColor Yellow
    Write-Host ""
    Write-Host "El manual en inglés se generó con la ESTRUCTURA correcta," -ForegroundColor White
    Write-Host "pero el CONTENIDO aún está en ESPAÑOL." -ForegroundColor White
    Write-Host ""
    Write-Host "Debes traducir manualmente los archivos HTML ubicados en:" -ForegroundColor Cyan
    Write-Host "   $sourceEnDir\html\" -ForegroundColor Yellow
    Write-Host ""
    Write-Host "Total de archivos a traducir: $htmlCount" -ForegroundColor White
    Write-Host ""
    Write-Host "Después de traducir, recompila con:" -ForegroundColor Cyan
    Write-Host "   cd `"$sourceEnDir`"" -ForegroundColor Gray
    Write-Host "   & `"$hhcPath`" `"help_en.hhp`"" -ForegroundColor Gray
    Write-Host ""
    Write-Host "????????????????????????????????????????????????????????????????" -ForegroundColor Yellow
    Write-Host ""
    
    # Preguntar si desea abrir el CHM
    $respuesta = Read-Host "¿Deseas abrir el manual para verificar? (S/N)"
    if ($respuesta -eq "S" -or $respuesta -eq "s") {
        Write-Host ""
        Write-Host "?? Abriendo help_en.chm..." -ForegroundColor Cyan
        Start-Process $chmFile
    }
    
} else {
    Write-Host ""
    Write-Host "??????????????????????????????????????????????????????????????????" -ForegroundColor Red
    Write-Host "?                                                                ?" -ForegroundColor Red
    Write-Host "?                    ? ERROR                                    ?" -ForegroundColor Red
    Write-Host "?                                                                ?" -ForegroundColor Red
    Write-Host "??????????????????????????????????????????????????????????????????" -ForegroundColor Red
    Write-Host ""
    Write-Host "No se generó el archivo help_en.chm" -ForegroundColor Red
    Write-Host ""
    Write-Host "Revisa los mensajes de error anteriores." -ForegroundColor Yellow
    Write-Host ""
    exit 1
}

Write-Host ""
Write-Host "????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
Write-Host "  Proceso completado" -ForegroundColor Cyan
Write-Host "????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
Write-Host ""
