# ?? Guía de Instalación en Producción

## ?? Orden de Ejecución de Scripts

Para una instalación limpia en producción, sigue estos pasos **EN ORDEN**:

---

## ? Paso 1: Crear las Bases de Datos

```sql
CREATE DATABASE DistribuidoraLosAmigos;
CREATE DATABASE Login;
CREATE DATABASE Bitacora;
```

---

## ? Paso 2: Crear las Tablas

Ejecutar los scripts de creación de tablas (esquema de BD) en este orden:

1. Crear tablas en `DistribuidoraLosAmigos`
2. Crear tablas en `Login`
3. Crear tablas en `Bitacora`

---

## ? Paso 3: **CRÍTICO** - Crear las 22 Patentes

**?? ESTE ES EL PASO MÁS IMPORTANTE**

```sql
-- Ejecutar ANTES de crear usuarios
USE [Login]
GO

EXEC [00_Crear_Patentes_Sistema.sql]
```

Este script crea las 22 patentes estándar del sistema:
- 8 patentes de tipo UI (Visualización)
- 14 patentes de tipo Control (Administración)

**Sin estas patentes, el usuario admin se creará sin permisos y no podrá usar el sistema.**

---

## ? Paso 4: Iniciar la Aplicación

Una vez que las patentes están creadas:

1. **Iniciar la aplicación**
2. El sistema detectará que no hay usuarios
3. **Automáticamente creará:**
   - Usuario: `admin`
   - Contraseña: `Admin123!`
   - Familia: `Administrador`
   - Asignará **TODAS las 22 patentes** a la familia
   - Asignará la familia al usuario admin

4. Aparecerá un mensaje informativo

---

## ? Paso 5: Primer Inicio de Sesión

```
Usuario: admin
Contraseña: Admin123!
```

**?? IMPORTANTE: Cambiar esta contraseña inmediatamente**

---

## ?? Solución de Problemas

### Problema: Usuario admin creado pero no puede ver menús

**Causa:** Las patentes NO existían cuando se creó el usuario.

**Solución:**

1. Verificar que las patentes existen:
```sql
SELECT COUNT(*) FROM Patente
-- Debería mostrar: 22
```

2. Si las patentes no existen:
```sql
EXEC [00_Crear_Patentes_Sistema.sql]
```

3. Luego ejecutar:
```sql
EXEC [11_Asignar_Rol_Admin_A_Usuario_Existente.sql]
```

4. Reiniciar la aplicación y volver a iniciar sesión

---

### Problema: No estoy seguro del estado del sistema

**Solución:** Ejecutar script de diagnóstico:

```sql
EXEC [12_Diagnostico_Sistema_Permisos.sql]
```

Este script te mostrará:
- ? Cuántas patentes hay
- ? Si el usuario admin existe
- ? Si tiene familia asignada
- ? Cuántas patentes tiene la familia
- ? Recomendaciones específicas

---

## ?? Flujo Correcto de Instalación

```
???????????????????????????????????
? 1. Crear Bases de Datos         ?
???????????????????????????????????
              ?
???????????????????????????????????
? 2. Crear Tablas (Esquema)       ?
???????????????????????????????????
              ?
???????????????????????????????????
? 3. ?? CREAR LAS 22 PATENTES     ?
?    (00_Crear_Patentes_Sistema)  ?
???????????????????????????????????
              ?
???????????????????????????????????
? 4. Iniciar Aplicación            ?
?    (Crea admin automáticamente)  ?
???????????????????????????????????
              ?
???????????????????????????????????
? 5. Login: admin / Admin123!      ?
?    ? Puede ver TODOS los menús  ?
???????????????????????????????????
```

---

## ? Flujo INCORRECTO (No hacer esto)

```
? INCORRECTO:
???????????????????????????????????
? 1. Crear BD y Tablas             ?
???????????????????????????????????
              ?
???????????????????????????????????
? 2. Iniciar Aplicación            ?
?    (Crea admin SIN patentes)     ?
???????????????????????????????????
              ?
???????????????????????????????????
? 3. Crear patentes                ?
?    (Ya es tarde - admin sin rol) ?
???????????????????????????????????
              ?
???????????????????????????????????
? ? Admin no puede hacer nada     ?
? Requiere script de corrección    ?
???????????????????????????????????
```

---

## ?? Checklist de Instalación

Antes de entregar a producción:

- [ ] ? Bases de datos creadas
- [ ] ? Tablas creadas
- [ ] ? **Script `00_Crear_Patentes_Sistema.sql` EJECUTADO**
- [ ] ? Verificar: `SELECT COUNT(*) FROM Patente` = 22
- [ ] ? Aplicación iniciada por primera vez
- [ ] ? Mensaje de creación de admin visto
- [ ] ? Login exitoso con admin / Admin123!
- [ ] ? Admin puede ver TODOS los menús
- [ ] ? Contraseña del admin cambiada
- [ ] ? Usuarios adicionales creados
- [ ] ? Backup creado y probado

---

## ?? Scripts Disponibles

| Script | Orden | Descripción |
|--------|-------|-------------|
| `00_Crear_Patentes_Sistema.sql` | **1º** | ? Crea las 22 patentes (EJECUTAR PRIMERO) |
| `00_Crear_Usuario_Admin_Default.sql` | 2º | Crea usuario admin manualmente (opcional) |
| `11_Asignar_Rol_Admin_A_Usuario_Existente.sql` | 3º | Corrige admin sin permisos |
| `12_Diagnostico_Sistema_Permisos.sql` | - | Diagnóstico completo del sistema |

---

## ?? Arquitectura de Permisos

El sistema usa **Familias (Roles)** para asignar permisos:

```
Usuario ? Usuario_Familia ? Familia ? Familia_Patente ? Patente
   ?            ?              ?            ?             ?
 admin   ?  Relación   ? Administrador ? Relación  ? 22 Patentes
```

**IMPORTANTE:**
- ? Tabla `Usuario_Patente`: **VACÍA** (correcto - no se usa)
- ? Tabla `Familia_Patente`: **LLENA** (aquí se asignan los permisos)

---

## ?? Soporte

Si tienes problemas:

1. **Ejecutar diagnóstico:**
   ```sql
   EXEC [12_Diagnostico_Sistema_Permisos.sql]
   ```

2. **Revisar logs de la aplicación:**
   ```
   C:\Logs\app.log
   C:\Logs\error.log
   ```

3. **Si admin no tiene permisos:**
   ```sql
   -- 1. Verificar patentes
   SELECT COUNT(*) FROM Patente
   
   -- 2. Si faltan, crear
   EXEC [00_Crear_Patentes_Sistema.sql]
   
   -- 3. Asignar al admin
   EXEC [11_Asignar_Rol_Admin_A_Usuario_Existente.sql]
   ```

---

## ?? Errores Comunes y Soluciones

### Error 1: "Usuario admin no puede ver ningún menú"
**Causa:** Patentes no existían al crear el usuario  
**Solución:** Ejecutar `00_Crear_Patentes_Sistema.sql` + `11_Asignar_Rol_Admin_A_Usuario_Existente.sql`

### Error 2: "Sistema lento al iniciar"
**Causa:** Verificación de permisos  
**Solución:** Normal - primera vez verifica y corrige

### Error 3: "No puedo crear patentes desde la aplicación"
**Causa:** Admin no tiene la patente "Crear_patente"  
**Solución:** Ejecutar `11_Asignar_Rol_Admin_A_Usuario_Existente.sql`

---

**Última actualización:** 2024  
**Versión:** 1.0  
**Estado:** ? Producción
